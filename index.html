<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>自由配置 YouTube プレイヤー</title>
  <style>
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: sans-serif;
      overflow: hidden;
    }
    #controls {
      padding: 10px;
      background: #111;
      white-space: nowrap;
    }
    input[type="text"] {
      width: 300px;
      padding: 5px;
      margin-right: 10px;
    }
    button {
      padding: 6px 12px;
      cursor: pointer;
      margin-right: 5px;
    }
    #container {
      position: relative;
      width: 100vw;
      height: calc(100vh - 60px);
      overflow: auto;
    }
    .video-box {
      position: absolute;
      border: 2px solid #444;
      overflow: hidden;
      background: #111;
    }
    .video-box iframe {
      width: 100%;
      height: calc(100% - 60px);
      display: block;
    }
    .controls {
      height: 60px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      background: #222;
      padding: 2px 6px;
      gap: 6px;
    }
    .volume-slider {
      width: 100px;
    }
    .delete-btn {
      background: red;
      color: white;
      border: none;
      padding: 2px 6px;
      cursor: pointer;
    }
    .move-controls {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .move-row {
      display: flex;
      justify-content: center;
    }
    .move-controls button {
      padding: 2px 6px;
      margin: 1px;
    }
  </style>
</head>
<body>
<div id="controls">
  <input type="text" id="videoUrl" placeholder="YouTubeのURLを入力">
  <button onclick="addVideo()">動画を追加</button>
  <button onclick="saveState()">保存</button>
  <button onclick="applySmartLayout()">スマホ配置</button>
  <button onclick="applyGridLayout()">2×2配置</button>
</div>
<div id="container"></div>
<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
<script>
let zIndexCounter = 1000;

function extractVideoID(url) {
  const patterns = [/(?:v=|\/embed\/|\.be\/|\/shorts\/|\/live\/)([a-zA-Z0-9_-]{11})/];
  for (const pattern of patterns) {
    const match = url.match(pattern);
    if (match) return match[1];
  }
  return null;
}

function addVideo(videoId = null, x = 50, y = 50, width = 480, height = 270, volume = 100) {
  const container = document.getElementById("container");
  if (!videoId) {
    const url = document.getElementById("videoUrl").value;
    videoId = extractVideoID(url);
    if (!videoId) {
      alert("有効なYouTubeリンクを入力してください");
      return;
    }
  }
  const box = document.createElement("div");
  box.className = "video-box";
  box.style.width = width + "px";
  box.style.height = height + "px";
  box.style.transform = `translate(${x}px, ${y}px)`;
  box.setAttribute("data-x", x);
  box.setAttribute("data-y", y);
  box.style.zIndex = zIndexCounter++;
  const iframe = document.createElement("iframe");
  iframe.src = `https://www.youtube.com/embed/${videoId}?enablejsapi=1`;
  iframe.allow = "autoplay; encrypted-media";
  iframe.allowFullscreen = true;
  const controls = document.createElement("div");
  controls.className = "controls";
  const volSlider = document.createElement("input");
  volSlider.type = "range";
  volSlider.min = 0;
  volSlider.max = 100;
  volSlider.value = volume;
  volSlider.className = "volume-slider";
  volSlider.oninput = () => {
    try {
      iframe.contentWindow.postMessage(JSON.stringify({
        event: "command",
        func: "setVolume",
        args: [volSlider.value]
      }), "*");
    } catch (e) { console.warn("音量設定失敗"); }
  };
  const moveBoxBtn = document.createElement("div");
  moveBoxBtn.className = "move-controls";
  moveBoxBtn.innerHTML = `
    <div class="move-row"><button onclick="moveBox(this, '↑')">↑</button></div>
    <div class="move-row">
      <button onclick="moveBox(this, '←')">←</button>
      <button onclick="moveBox(this, '→')">→</button>
    </div>
    <div class="move-row"><button onclick="moveBox(this, '↓')">↓</button></div>`;
  const delBtn = document.createElement("button");
  delBtn.className = "delete-btn";
  delBtn.textContent = "×";
  delBtn.onclick = () => container.removeChild(box);
  controls.appendChild(volSlider);
  controls.appendChild(moveBoxBtn);
  controls.appendChild(delBtn);
  box.appendChild(controls);
  box.appendChild(iframe);
  container.appendChild(box);
  box.addEventListener("mousedown", () => box.style.zIndex = zIndexCounter++);
  makeDraggableAndResizable(box);
  document.getElementById("videoUrl").value = "";
}

function moveBox(button, dir) {
  const box = button.closest('.video-box');
  const step = 10;
  let x = parseFloat(box.getAttribute('data-x')) || 0;
  let y = parseFloat(box.getAttribute('data-y')) || 0;
  if (dir === "↑") y -= step;
  if (dir === "↓") y += step;
  if (dir === "←") x -= step;
  if (dir === "→") x += step;
  box.style.transform = `translate(${x}px, ${y}px)`;
  box.setAttribute("data-x", x);
  box.setAttribute("data-y", y);
}

function makeDraggableAndResizable(el) {
  interact(el)
    .draggable({
      listeners: {
        move(event) {
          const { dx, dy } = event;
          const x = (parseFloat(el.getAttribute('data-x')) || 0) + dx;
          const y = (parseFloat(el.getAttribute('data-y')) || 0) + dy;
          el.style.transform = `translate(${x}px, ${y}px)`;
          el.setAttribute('data-x', x);
          el.setAttribute('data-y', y);
        }
      }
    })
    .resizable({
      edges: { left: true, right: true, bottom: true, top: true },
      listeners: {
        move(event) {
          const iframe = event.target.querySelector('iframe');
          if (iframe) iframe.style.pointerEvents = 'none';
          let x = (parseFloat(event.target.getAttribute('data-x')) || 0) + event.deltaRect.left;
          let y = (parseFloat(event.target.getAttribute('data-y')) || 0) + event.deltaRect.top;
          Object.assign(event.target.style, {
            width: `${event.rect.width}px`,
            height: `${event.rect.height}px`,
            transform: `translate(${x}px, ${y}px)`
          });
          event.target.setAttribute('data-x', x);
          event.target.setAttribute('data-y', y);
        },
        end(event) {
          const iframe = event.target.querySelector('iframe');
          if (iframe) iframe.style.pointerEvents = 'auto';
        }
      },
      modifiers: [
        interact.modifiers.restrictSize({
          min: { width: 160, height: 100 },
          max: { width: 1280, height: 800 }
        })
      ]
    });
}

function saveState() {
  const boxes = document.querySelectorAll('.video-box');
  const data = [];
  boxes.forEach(box => {
    const iframe = box.querySelector('iframe');
    const src = iframe.src;
    const videoIdMatch = src.match(/\/embed\/([a-zA-Z0-9_-]{11})/);
    if (!videoIdMatch) return;
    const videoId = videoIdMatch[1];
    const x = parseFloat(box.getAttribute('data-x')) || 0;
    const y = parseFloat(box.getAttribute('data-y')) || 0;
    const width = box.offsetWidth;
    const height = box.offsetHeight;
    const volume = box.querySelector('.volume-slider').value;
    data.push({ videoId, x, y, width, height, volume });
  });
  localStorage.setItem('videoData', JSON.stringify(data));
  alert('保存しました！');
}

function loadSavedVideos() {
  const data = JSON.parse(localStorage.getItem('videoData') || '[]');
  data.forEach(v => addVideo(v.videoId, v.x, v.y, v.width, v.height, v.volume));
}

function applySmartLayout() {
  const boxes = document.querySelectorAll('.video-box');
  let top = 10;
  boxes.forEach(box => {
    const width = Math.min(window.innerWidth - 20, 360);
    const height = (width / 16) * 9 + 60;
    box.style.width = width + "px";
    box.style.height = height + "px";
    box.style.transform = `translate(10px, ${top}px)`;
    box.setAttribute("data-x", 10);
    box.setAttribute("data-y", top);
    top += height + 20;
  });
}

function applyGridLayout() {
  const boxes = document.querySelectorAll('.video-box');
  const screenWidth = window.innerWidth;
  const screenHeight = window.innerHeight;
  const cols = 2;
  const width = screenWidth / cols - 40;
  const height = (width / 16) * 9 + 60;
  boxes.forEach((box, index) => {
    const col = index % cols;
    const row = Math.floor(index / cols);
    const x = col * (width + 20) + 10;
    const y = row * (height + 20) + 10;
    box.style.width = width + "px";
    box.style.height = height + "px";
    box.style.transform = `translate(${x}px, ${y}px)`;
    box.setAttribute("data-x", x);
    box.setAttribute("data-y", y);
  });
}

window.onload = loadSavedVideos;
</script>
</body>
</html>
