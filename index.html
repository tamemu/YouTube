<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><title>修正版プレイヤー</title><style>
body{margin:0;background:#000;color:#fff;font-family:sans-serif;overflow:hidden;}
#controls{padding:10px;background:#111;white-space:nowrap;}
input,button{padding:5px;margin-right:5px;}
#container{position:relative;width:100vw;height:calc(100vh-60px);overflow:auto;}
.video-box{position:absolute;border:2px solid #444;background:#111;overflow:hidden;}
.video-box iframe{width:100%;height:calc(100%-40px);}
.controls{position:relative;display:flex;align-items:center;background:#222;height:40px;padding:2px;gap:6px;}
.close-btn{position:absolute;top:2px;right:2px;background:red;color:#fff;border:none;padding:2px;cursor:pointer;}
.volume-slider{width:100px;}
</style></head><body>
<div id="controls">
  <input id="videoUrl" placeholder="YouTubeのURL">
  <button onclick="addVideo()">動画を追加</button>
  <button onclick="setLayout('single')">1×1配置</button>
  <button onclick="setLayout('grid2')">2×2配置</button>
  <button onclick="setLayout('grid3')">3×3配置</button>
</div>
<div id="container"></div>
<script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
<script>
let zIdx=1000, currentLayout='single';

function extractID(url) {
  const m=url.match(/(?:v=|\/embed\/|\.be\/|\/shorts\/|\/live\/)([\w-]{11})/);
  return m?m[1]:null;
}

function addVideo(id=null,x=50,y=50,w=480,h=270,vol=100) {
  if (!id) {
    const url=document.getElementById('videoUrl').value;
    id=extractID(url);
    if (!id) return alert('有効なリンクを入力してください');
  }
  const box=document.createElement('div');
  box.className='video-box'; box.style.width=w+'px';box.style.height=h+'px';
  box.style.left=x+'px';box.style.top=y+'px';box.style.zIndex=zIdx++;

  const iframe=document.createElement('iframe');
  iframe.src=`https://www.youtube.com/embed/${id}?enablejsapi=1`;
  iframe.allow='autoplay; encrypted-media';iframe.allowFullscreen=true;

  const ctrl=document.createElement('div');ctrl.className='controls';
  const up=document.createElement('button'); up.textContent='↑'; up.onclick=()=>moveVideo(box,-1);
  const down=document.createElement('button'); down.textContent='↓'; down.onclick=()=>moveVideo(box,1);
  const volS=document.createElement('input');volS.type='range';volS.min=0;volS.max=100;volS.value=vol;
  volS.className='volume-slider';volS.onmousedown=e=>e.stopPropagation();volS.ontouchstart=e=>e.stopPropagation();
  volS.oninput=()=>iframe.contentWindow.postMessage(JSON.stringify({event:'command',func:'setVolume',args:[volS.value]}),'*');
  const closeB=document.createElement('button');closeB.className='close-btn';closeB.textContent='×';
  closeB.onclick=()=>{box.remove();saveState();};

  ctrl.append(up,down,volS,closeB);
  box.append(ctrl,iframe);
  document.getElementById('container').append(box);
  box.addEventListener('mousedown',()=>box.style.zIndex=zIdx++);
  interactBox(box);
  document.getElementById('videoUrl').value='';
}

function moveVideo(box,dir){
  const ctr=document.getElementById('container'), vids=[...ctr.children].filter(c=>c.classList.contains('video-box'));
  const i=vids.indexOf(box), t=i+dir;
  if(t<0||t>=vids.length)return;
  ctr.insertBefore(box, vids[t+(dir>0?1:0)]);
  applyLayout(); saveState();
}

function interactBox(el){
  interact(el).draggable({ listeners:{move(e){
    const t=e.target;
    t.style.left=(parseFloat(t.style.left)||0)+e.dx+'px';
    t.style.top=(parseFloat(t.style.top)||0)+e.dy+'px';
  }},ignoreFrom:'input'}).resizable({
    edges:{left:true,right:true,bottom:true,top:false},modifiers:[interact.modifiers.restrictSize({min:{width:160,height:100},max:{width:1280,height:800}})],
    listeners:{move(e){
      const t=e.target, ifr=t.querySelector('iframe'); if(ifr)ifr.style.pointerEvents='none';
      const edges=e.edges;
      if(!( (edges.bottom&&edges.right)||(edges.bottom&&edges.left) )) return;
      t.style.width=e.rect.width+'px';t.style.height=e.rect.height+'px';
      t.style.left=(parseFloat(t.style.left)||0)+e.deltaRect.left+'px';
      t.style.top=(parseFloat(t.style.top)||0)+e.deltaRect.top+'px';
    },end(e){
      const ifr=e.target.querySelector('iframe'); if(ifr)ifr.style.pointerEvents='auto';
      saveState();
    }}
  });
}

function saveState(){
  const arr=[...document.querySelectorAll('.video-box')].map(b=>({
    id: b.querySelector('iframe').src.match(/embed\/([\w-]{11})/)[1],
    x:+b.style.left,y:+b.style.top,w:b.offsetWidth,h:b.offsetHeight,
    vol:b.querySelector('.volume-slider').value
  }));
  localStorage.setItem('vd',JSON.stringify({layout:currentLayout,v:arr}));
}

function loadState(){
  const s=localStorage.getItem('vd');
  if(!s)return;
  const {layout,v}=JSON.parse(s);
  currentLayout=layout;
  v.forEach(o=>addVideo(o.id,o.x,o.y,o.w,o.h,o.vol));
}

function setLayout(l){currentLayout=l; applyLayout(); saveState();}
function applyLayout(){
  const boxes=[...document.querySelectorAll('.video-box')];
  if(currentLayout==='single'){
    let top=10, w=window.innerWidth-20, h=(w/16)*9+40;
    boxes.forEach(b=>{b.style.width=w+'px';b.style.height=h+'px';b.style.left='10px';b.style.top=top+'px';top+=h+20;});
  } else {
    const cols=+currentLayout.slice(-1), sw=window.innerWidth;
    const w=sw/cols-40, h=(w/16)*9+40;
    boxes.forEach((b,i)=>{const c=i%cols,r=(i/cols|0);b.style.width=w+'px';b.style.height=h+'px';
      b.style.left=c*(w+20)+10+'px';b.style.top=r*(h+20)+10+'px';});
  }
}

window.onload=()=>{loadState();applyLayout();}
</script></body></html>
