<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>自由配置 YouTube プレイヤー</title>
  <style>
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: sans-serif;
      overflow: hidden;
    }
    #controls {
      padding: 10px;
      background: #111;
      white-space: nowrap;
    }
    input, button {
      padding: 6px;
      margin-right: 6px;
    }
    #container {
      position: relative;
      width: 100vw;
      height: calc(100vh - 60px);
      overflow: auto;
    }
    .video-box {
      position: absolute;
      background: #111;
      border: 2px solid #444;
      overflow: hidden;
    }
    .video-box iframe {
      width: 100%;
      height: calc(100% - 40px);
      display: block;
    }
    .controls {
      height: 40px;
      display: flex;
      align-items: center;
      background: #222;
      padding: 2px 4px;
      gap: 6px;
    }
    .volume-slider {
      width: 100px;
    }
    .close-btn {
      background: red;
      color: white;
      border: none;
      padding: 4px 6px;
      cursor: pointer;
      margin-left: auto;
    }
  </style>
</head>
<body>
  <div id="controls">
    <input id="videoUrl" placeholder="YouTubeのURL">
    <button onclick="addVideo()">動画を追加</button>
    <button onclick="applyLayout('1x1')">1×1配置</button>
    <button onclick="applyLayout('2x2')">2×2配置</button>
    <button onclick="applyLayout('3x3')">3×3配置</button>
  </div>
  <div id="container"></div>

  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
  <script>
    let zIndex = 1000;
    let currentLayout = '1x1';

    function extractVideoID(url) {
      const match = url.match(/(?:v=|\/embed\/|\.be\/|\/shorts\/|\/live\/)([a-zA-Z0-9_-]{11})/);
      return match ? match[1] : null;
    }

    function addVideo(videoId = null, x = 50, y = 50, width = 480, height = 270, volume = 100) {
      if (!videoId) {
        const url = document.getElementById("videoUrl").value;
        videoId = extractVideoID(url);
        if (!videoId) {
          alert("有効なYouTubeリンクを入力してください");
          return;
        }
      }

      const container = document.getElementById("container");
      const box = document.createElement("div");
      box.className = "video-box";
      box.style.width = width + "px";
      box.style.height = height + "px";
      box.style.left = x + "px";
      box.style.top = y + "px";
      box.style.zIndex = zIndex++;

      const iframe = document.createElement("iframe");
      iframe.src = `https://www.youtube.com/embed/${videoId}?enablejsapi=1`;
      iframe.allow = "autoplay; encrypted-media";
      iframe.allowFullscreen = true;

      const controls = document.createElement("div");
      controls.className = "controls";

      const upBtn = document.createElement("button");
      upBtn.textContent = "↑";
      upBtn.onclick = () => moveVideo(box, -1);

      const downBtn = document.createElement("button");
      downBtn.textContent = "↓";
      downBtn.onclick = () => moveVideo(box, 1);

      const volumeSlider = document.createElement("input");
      volumeSlider.type = "range";
      volumeSlider.min = 0;
      volumeSlider.max = 100;
      volumeSlider.value = volume;
      volumeSlider.className = "volume-slider";
      volumeSlider.onmousedown = e => e.stopPropagation();
      volumeSlider.oninput = () => {
        iframe.contentWindow.postMessage(JSON.stringify({
          event: "command",
          func: "setVolume",
          args: [volumeSlider.value]
        }), "*");
      };

      const closeBtn = document.createElement("button");
      closeBtn.className = "close-btn";
      closeBtn.textContent = "×";
      closeBtn.onclick = () => {
        container.removeChild(box);
        saveState();
      };

      controls.append(upBtn, downBtn, volumeSlider, closeBtn);
      box.append(controls, iframe);
      container.append(box);
      makeDraggableAndResizable(box);
      box.addEventListener("mousedown", () => box.style.zIndex = zIndex++);

      document.getElementById("videoUrl").value = "";
      saveState();
    }

    function makeDraggableAndResizable(el) {
      interact(el)
        .draggable({
          listeners: {
            move(event) {
              const target = event.target;
              const x = (parseFloat(target.style.left) || 0) + event.dx;
              const y = (parseFloat(target.style.top) || 0) + event.dy;
              target.style.left = x + "px";
              target.style.top = y + "px";
            }
          }
        })
        .resizable({
          edges: { left: true, right: true, bottom: true, top: false },
          listeners: {
            move(event) {
              const target = event.target;
              const iframe = target.querySelector("iframe");
              if (iframe) iframe.style.pointerEvents = 'none';
              const x = (parseFloat(target.style.left) || 0) + event.deltaRect.left;
              const y = (parseFloat(target.style.top) || 0) + event.deltaRect.top;
              Object.assign(target.style, {
                width: `${event.rect.width}px`,
                height: `${event.rect.height}px`,
                left: `${x}px`,
                top: `${y}px`
              });
            },
            end(event) {
              const iframe = event.target.querySelector("iframe");
              if (iframe) iframe.style.pointerEvents = 'auto';
              saveState();
            }
          },
          modifiers: [
            interact.modifiers.restrictSize({
              min: { width: 160, height: 100 },
              max: { width: 1280, height: 800 }
            })
          ]
        });
    }

    function moveVideo(box, direction) {
      const container = document.getElementById("container");
      const boxes = Array.from(container.querySelectorAll(".video-box"));
      const index = boxes.indexOf(box);
      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= boxes.length) return;
      container.insertBefore(box, boxes[direction > 0 ? newIndex + 1 : newIndex]);
      saveState();
    }

    function applyLayout(type) {
      const boxes = document.querySelectorAll(".video-box");
      currentLayout = type;
      const containerWidth = window.innerWidth;
      let cols = 1;
      if (type === '2x2') cols = 2;
      if (type === '3x3') cols = 3;
      const width = containerWidth / cols - 40;
      const height = (width / 16) * 9 + 40;
      boxes.forEach((box, index) => {
        const col = index % cols;
        const row = Math.floor(index / cols);
        const x = col * (width + 20) + 10;
        const y = row * (height + 20) + 10;
        box.style.width = width + "px";
        box.style.height = height + "px";
        box.style.left = x + "px";
        box.style.top = y + "px";
      });
      saveState();
    }

    function saveState() {
      const boxes = document.querySelectorAll(".video-box");
      const data = Array.from(boxes).map(box => {
        const iframe = box.querySelector("iframe");
        const match = iframe.src.match(/embed\/([a-zA-Z0-9_-]{11})/);
        return {
          id: match ? match[1] : null,
          x: parseFloat(box.style.left),
          y: parseFloat(box.style.top),
          width: box.offsetWidth,
          height: box.offsetHeight,
          volume: box.querySelector("input").value
        };
      });
      localStorage.setItem("videoData", JSON.stringify(data));
    }

    function loadState() {
      const data = JSON.parse(localStorage.getItem("videoData") || "[]");
      data.forEach(v => addVideo(v.id, v.x, v.y, v.width, v.height, v.volume));
    }

    window.onload = loadState;
  </script>
</body>
</html>
