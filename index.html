<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>カテゴリ選択付き YouTubeプレイヤー</title>
  <style>
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: sans-serif;
      overflow: hidden;
    }
    #controls {
      padding: 10px;
      background: #111;
      white-space: nowrap;
    }
    select, input, button {
      margin: 4px;
      padding: 4px;
    }
    #filterArea {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 6px;
    }
    #sheetVideoList {
      width: 300px;
      height: 120px;
    }
    #container {
      position: relative;
      width: 100vw;
      height: calc(100vh - 160px);
      overflow: auto;
    }
    .video-box {
      position: absolute;
      background: #111;
      border: 2px solid #444;
      overflow: hidden;
    }
    .controls {
      height: 40px;
      display: flex;
      align-items: center;
      background: #222;
      padding: 2px 4px;
      gap: 6px;
    }
    .volume-slider {
      width: 100px;
    }
    .close-btn {
      background: red;
      color: white;
      border: none;
      padding: 4px 6px;
      cursor: pointer;
      margin-left: auto;
    }
  </style>
</head>
<body>
  <div id="controls">
    <div id="filterArea">
      <select id="mainCategory" onchange="filterVideos()">
        <option value="">-- 大分類 --</option>
      </select>
      <select id="subCategory" onchange="filterVideos()">
        <option value="">-- 小分類 --</option>
      </select>
      <button onclick="clearFilters()">全解除</button>
    </div>
    <select id="sheetVideoList" multiple></select>
    <button onclick="addSelectedVideos()">選択した動画を追加</button>
    <br>
    <input id="videoUrl" placeholder="YouTubeのURL">
    <button onclick="addVideo()">URLから追加</button>
    <button onclick="applyLayout('1x1')">1×1配置</button>
    <button onclick="applyLayout('2x2')">2×2配置</button>
    <button onclick="applyLayout('3x3')">3×3配置</button>
  </div>
  <div id="container"></div>

  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    let zIndex = 1000;
    let playerMap = {};
    const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTwHDe9XYtJGqxS_aEGJB7lDK-StQ4UKrrnxKALrPPmVL0aNrEyWwv1wilX-ohr1LQDYn5rvPb0EQll/pub?gid=1636424413&single=true&output=csv";

    let videoData = []; // 全データ保持

    function extractVideoID(url) {
      const match = url.match(/(?:\/|v=|embed\/|shorts\/|live\/|\.be\/)([a-zA-Z0-9_-]{11})/);
      return match ? match[1] : null;
    }

    async function loadSpreadsheet() {
      const res = await fetch(sheetUrl);
      const text = await res.text();
      const lines = text.trim().split("\n").slice(1); // skip header

      videoData = lines.map(line => {
        const [name, main, sub, url] = line.split(",").map(v => v?.replace(/"/g, "").trim());
        return { name, main, sub, url };
      }).filter(v => v.url);

      populateFilters();
      filterVideos(); // 初期表示
    }

    function populateFilters() {
      const mainSet = new Set();
      const subSet = new Set();

      videoData.forEach(v => {
        mainSet.add(v.main);
        subSet.add(v.sub);
      });

      const mainSel = document.getElementById("mainCategory");
      const subSel = document.getElementById("subCategory");
      [mainSel, subSel].forEach(sel => sel.innerHTML = '<option value="">-- 全て --</option>');

      [...mainSet].sort().forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        mainSel.appendChild(opt);
      });

      [...subSet].sort().forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        subSel.appendChild(opt);
      });
    }

    function filterVideos() {
      const main = document.getElementById("mainCategory").value;
      const sub = document.getElementById("subCategory").value;
      const list = document.getElementById("sheetVideoList");
      list.innerHTML = "";

      videoData
        .filter(v => (!main || v.main === main) && (!sub || v.sub === sub))
        .forEach(v => {
          const opt = document.createElement("option");
          opt.value = v.url;
          opt.textContent = `${v.name} (${v.main}/${v.sub})`;
          list.appendChild(opt);
        });
    }

    function clearFilters() {
      document.getElementById("mainCategory").value = "";
      document.getElementById("subCategory").value = "";
      filterVideos();
    }

    function addSelectedVideos() {
      const selected = [...document.getElementById("sheetVideoList").selectedOptions];
      selected.forEach(opt => {
        const id = extractVideoID(opt.value);
        if (id) addVideo(id);
      });
    }

    function addVideo(videoId = null, x = 50, y = 50, width = 480, height = 270, volume = 100) {
      if (!videoId) {
        const url = document.getElementById("videoUrl").value;
        videoId = extractVideoID(url);
        if (!videoId) {
          alert("有効なYouTubeリンクを入力してください");
          return;
        }
      }

      const container = document.getElementById("container");
      const box = document.createElement("div");
      box.className = "video-box";
      box.style.width = width + "px";
      box.style.height = height + "px";
      box.style.left = x + "px";
      box.style.top = y + "px";
      box.style.zIndex = zIndex++;

      const playerId = `player_${videoId}_${Date.now()}`;
      const playerDiv = document.createElement("div");
      playerDiv.id = playerId;
      playerDiv.style.width = "100%";
      playerDiv.style.height = "calc(100% - 40px)";
      box.appendChild(playerDiv);

      const controls = document.createElement("div");
      controls.className = "controls";

      const upBtn = document.createElement("button");
      upBtn.textContent = "↑";
      upBtn.onclick = () => moveVideo(box, -1);

      const downBtn = document.createElement("button");
      downBtn.textContent = "↓";
      downBtn.onclick = () => moveVideo(box, 1);

      const volumeSlider = document.createElement("input");
      volumeSlider.type = "range";
      volumeSlider.min = 0;
      volumeSlider.max = 100;
      volumeSlider.value = volume;
      volumeSlider.className = "volume-slider";
      volumeSlider.addEventListener("mousedown", e => e.stopPropagation());
      volumeSlider.addEventListener("touchstart", e => e.stopPropagation());

      const closeBtn = document.createElement("button");
      closeBtn.className = "close-btn";
      closeBtn.textContent = "×";
      closeBtn.onclick = () => {
        if (playerMap[playerId]) playerMap[playerId].destroy();
        container.removeChild(box);
        saveState();
      };

      controls.append(upBtn, downBtn, volumeSlider, closeBtn);
      box.append(controls);
      container.append(box);
      makeDraggableAndResizable(box);
      box.addEventListener("mousedown", () => box.style.zIndex = zIndex++);

      playerMap[playerId] = new YT.Player(playerId, {
        videoId: videoId,
        events: {
          onReady: event => {
            event.target.setVolume(volume);
            event.target.setPlaybackRate(2);
          }
        }
      });

      volumeSlider.oninput = () => {
        const player = playerMap[playerId];
        if (player) player.setVolume(volumeSlider.value);
      };

      saveState();
    }

    function moveVideo(box, direction) {
      const container = document.getElementById("container");
      const boxes = Array.from(container.querySelectorAll(".video-box"));
      const index = boxes.indexOf(box);
      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= boxes.length) return;
      container.insertBefore(box, boxes[direction > 0 ? newIndex + 1 : newIndex]);
      saveState();
    }

    function applyLayout(type) {
      const boxes = document.querySelectorAll(".video-box");
      let cols = { '1x1': 1, '2x2': 2, '3x3': 3 }[type] || 1;
      const containerWidth = window.innerWidth;
      const width = containerWidth / cols - 40;
      const height = (width / 16) * 9 + 40;

      boxes.forEach((box, i) => {
        const col = i % cols;
        const row = Math.floor(i / cols);
        box.style.width = width + "px";
        box.style.height = height + "px";
        box.style.left = col * (width + 20) + "px";
        box.style.top = row * (height + 20) + "px";
      });

      saveState();
    }

    function makeDraggableAndResizable(el) {
      interact(el)
        .draggable({
          listeners: {
            move(event) {
              const target = event.target;
              const x = (parseFloat(target.style.left) || 0) + event.dx;
              const y = (parseFloat(target.style.top) || 0) + event.dy;
              target.style.left = x + "px";
              target.style.top = y + "px";
            }
          }
        })
        .resizable({
          edges: { left: true, right: true, bottom: true, top: false },
          listeners: {
            move(event) {
              const target = event.target;
              const x = (parseFloat(target.style.left) || 0) + event.deltaRect.left;
              const y = (parseFloat(target.style.top) || 0) + event.deltaRect.top;
              Object.assign(target.style, {
                width: `${event.rect.width}px`,
                height: `${event.rect.height}px`,
                left: `${x}px`,
                top: `${y}px`
              });
            },
            end() {
              saveState();
            }
          },
          modifiers: [
            interact.modifiers.restrictSize({
              min: { width: 160, height: 100 },
              max: { width: 1280, height: 800 }
            })
          ]
        });
    }

    function saveState() {
      const boxes = document.querySelectorAll(".video-box");
      const data = Array.from(boxes).map(box => {
        const playerDiv = box.querySelector("div[id^='player_']");
        const match = playerDiv?.id.match(/player_([a-zA-Z0-9_-]{11})/);
        return {
          id: match ? match[1] : null,
          x: parseFloat(box.style.left),
          y: parseFloat(box.style.top),
          width: box.offsetWidth,
          height: box.offsetHeight,
          volume: box.querySelector("input").value
        };
      }).filter(v => v.id);
      localStorage.setItem("videoData", JSON.stringify(data));
    }

    function loadState() {
      const data = JSON.parse(localStorage.getItem("videoData") || "[]");
      data.forEach(v => addVideo(v.id, v.x, v.y, v.width, v.height, v.volume));
    }

    function onYouTubeIframeAPIReady() {
      // 初期化後ロード
    }

    window.onload = () => {
      loadSpreadsheet();
      loadState();
    };
  </script>
</body>
</html>
