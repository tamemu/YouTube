<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>è‡ªç”±é…ç½® YouTube ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆå€é€Ÿå†ç”Ÿï¼‰</title>
  <style>
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: sans-serif;
      overflow: hidden;
    }
    #controls {
      padding: 10px;
      background: #111;
      white-space: nowrap;
    }
    input, button {
      padding: 6px;
      margin-right: 6px;
    }
    #container {
      position: relative;
      width: 100vw;
      height: calc(100vh - 60px);
      overflow: auto;
    }
    .video-box {
      position: absolute;
      background: #111;
      border: 2px solid #444;
      overflow: hidden;
    }
    .controls {
      height: 40px;
      display: flex;
      align-items: center;
      background: #222;
      padding: 2px 4px;
      gap: 6px;
    }
    .volume-slider {
      width: 100px;
    }
    .close-btn {
      background: red;
      color: white;
      border: none;
      padding: 4px 6px;
      cursor: pointer;
      margin-left: auto;
    }
  </style>
</head>
<body>
  <div id="controls">
    <input id="videoUrl" placeholder="YouTubeã®URL">
    <button onclick="addVideo()">å‹•ç”»ã‚’è¿½åŠ </button>
    <button onclick="applyLayout('1x1')">1Ã—1é…ç½®</button>
    <button onclick="applyLayout('2x2')">2Ã—2é…ç½®</button>
    <button onclick="applyLayout('3x3')">3Ã—3é…ç½®</button>
  </div>
  <div id="container"></div>

  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
  <script>
    let zIndex = 1000;
    let currentLayout = '1x1';
    let playerMap = {}; // IDã”ã¨ã®YTãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¿å­˜

    // YouTube IFrame APIèª­ã¿è¾¼ã¿
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    document.head.appendChild(tag);

    function onYouTubeIframeAPIReady() {
      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆã¯ addVideo ã§è¡Œã†
    }

    function extractVideoID(url) {
      const match = url.match(/(?:\/|v=|embed\/|shorts\/|live\/|\.be\/)([a-zA-Z0-9_-]{11})/);
      return match ? match[1] : null;
    }

    function addVideo(videoId = null, x = 50, y = 50, width = 480, height = 270, volume = 100) {
      if (!videoId) {
        const url = document.getElementById("videoUrl").value;
        videoId = extractVideoID(url);
        if (!videoId) {
          alert("æœ‰åŠ¹ãªYouTubeãƒªãƒ³ã‚¯ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
          return;
        }
      }

      const container = document.getElementById("container");
      const box = document.createElement("div");
      box.className = "video-box";
      box.style.width = width + "px";
      box.style.height = height + "px";
      box.style.left = x + "px";
      box.style.top = y + "px";
      box.style.zIndex = zIndex++;

      const playerId = `player_${videoId}_${Date.now()}`;
      const playerDiv = document.createElement("div");
      playerDiv.id = playerId;
      playerDiv.style.width = "100%";
      playerDiv.style.height = "calc(100% - 40px)";
      box.appendChild(playerDiv);

      const controls = document.createElement("div");
      controls.className = "controls";

      const upBtn = document.createElement("button");
      upBtn.textContent = "â†‘";
      upBtn.onclick = () => moveVideo(box, -1);

      const downBtn = document.createElement("button");
      downBtn.textContent = "â†“";
      downBtn.onclick = () => moveVideo(box, 1);

      const volumeSlider = document.createElement("input");
      volumeSlider.type = "range";
      volumeSlider.min = 0;
      volumeSlider.max = 100;
      volumeSlider.value = volume;
      volumeSlider.className = "volume-slider";
      volumeSlider.addEventListener("mousedown", e => e.stopPropagation());
      volumeSlider.addEventListener("touchstart", e => e.stopPropagation());

      const closeBtn = document.createElement("button");
      closeBtn.className = "close-btn";
      closeBtn.textContent = "Ã—";
      closeBtn.onclick = () => {
        if (playerMap[playerId]) playerMap[playerId].destroy();
        container.removeChild(box);
        saveState();
      };

      controls.append(upBtn, downBtn, volumeSlider, closeBtn);
      box.append(controls);
      container.append(box);
      makeDraggableAndResizable(box);
      box.addEventListener("mousedown", () => box.style.zIndex = zIndex++);

      document.getElementById("videoUrl").value = "";

      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½œæˆ
      playerMap[playerId] = new YT.Player(playerId, {
        videoId: videoId,
        events: {
          onReady: (event) => {
            event.target.setVolume(volume);
            event.target.setPlaybackRate(2); // ğŸ¯ 2å€é€Ÿå†ç”Ÿ
          }
        }
      });

      // éŸ³é‡å¤‰æ›´
      volumeSlider.oninput = () => {
        const player = playerMap[playerId];
        if (player) player.setVolume(volumeSlider.value);
      };

      saveState();
    }

    function moveVideo(box, direction) {
      const container = document.getElementById("container");
      const boxes = Array.from(container.querySelectorAll(".video-box"));
      const index = boxes.indexOf(box);
      const newIndex = index + direction;
      if (newIndex < 0 || newIndex >= boxes.length) return;
      container.insertBefore(box, boxes[direction > 0 ? newIndex + 1 : newIndex]);
      saveState();
    }

    function applyLayout(type) {
      const boxes = document.querySelectorAll(".video-box");
      currentLayout = type;
      const containerWidth = window.innerWidth;
      let cols = 1;
      if (type === '2x2') cols = 2;
      if (type === '3x3') cols = 3;
      const width = containerWidth / cols - 40;
      const height = (width / 16) * 9 + 40;
      boxes.forEach((box, index) => {
        const col = index % cols;
        const row = Math.floor(index / cols);
        const x = col * (width + 20) + 10;
        const y = row * (height + 20) + 10;
        box.style.width = width + "px";
        box.style.height = height + "px";
        box.style.left = x + "px";
        box.style.top = y + "px";
      });
      saveState();
    }

    function makeDraggableAndResizable(el) {
      interact(el)
        .draggable({
          listeners: {
            move(event) {
              const target = event.target;
              const x = (parseFloat(target.style.left) || 0) + event.dx;
              const y = (parseFloat(target.style.top) || 0) + event.dy;
              target.style.left = x + "px";
              target.style.top = y + "px";
            }
          }
        })
        .resizable({
          edges: { left: true, right: true, bottom: true, top: false },
          listeners: {
            move(event) {
              const target = event.target;
              const x = (parseFloat(target.style.left) || 0) + event.deltaRect.left;
              const y = (parseFloat(target.style.top) || 0) + event.deltaRect.top;
              Object.assign(target.style, {
                width: `${event.rect.width}px`,
                height: `${event.rect.height}px`,
                left: `${x}px`,
                top: `${y}px`
              });
            },
            end() {
              saveState();
            }
          },
          modifiers: [
            interact.modifiers.restrictSize({
              min: { width: 160, height: 100 },
              max: { width: 1280, height: 800 }
            })
          ]
        });
    }

    function saveState() {
      const boxes = document.querySelectorAll(".video-box");
      const data = Array.from(boxes).map(box => {
        const playerDiv = box.querySelector("div[id^='player_']");
        const match = playerDiv?.id.match(/player_([a-zA-Z0-9_-]{11})/);
        return {
          id: match ? match[1] : null,
          x: parseFloat(box.style.left),
          y: parseFloat(box.style.top),
          width: box.offsetWidth,
          height: box.offsetHeight,
          volume: box.querySelector("input").value
        };
      }).filter(v => v.id);
      localStorage.setItem("videoData", JSON.stringify(data));
    }

    function loadState() {
      const data = JSON.parse(localStorage.getItem("videoData") || "[]");
      data.forEach(v => addVideo(v.id, v.x, v.y, v.width, v.height, v.volume));
    }

    window.onload = loadState;
  </script>
</body>
</html>
